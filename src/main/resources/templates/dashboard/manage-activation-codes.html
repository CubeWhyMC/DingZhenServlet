<!-- public/manage-activation-codes.html -->
<div class="mdui-typo">
    <h1>管理激活码</h1>
</div>

<div class="mdui-row">
    <div class="mdui-col-md-6">
        <div class="mdui-card">
            <div class="mdui-card-primary">
                <div class="mdui-card-primary-title">生成激活码</div>
            </div>
            <div class="mdui-card-content">
                <div class="mdui-textfield">
                    <label class="mdui-textfield-label">天数</label>
                    <input class="mdui-textfield-input" type="number" id="days" min="1"/>
                </div>
                <div class="mdui-textfield">
                    <label class="mdui-textfield-label">数量</label>
                    <input class="mdui-textfield-input" type="number" id="count" min="1"/>
                </div>
            </div>
            <div class="mdui-card-actions">
                <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="generateCodes()">生成激活码</button>
            </div>
        </div>
    </div>
    <div class="mdui-col-md-6">
        <div class="mdui-card">
            <div class="mdui-card-primary">
                <div class="mdui-card-primary-title">激活码列表</div>
            </div>
            <div class="mdui-card-content">
                <ul class="mdui-list" id="code-list">
                    <!-- 激活码将在这里动态添加 -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
const adminPassword = sessionStorage.getItem('adminPassword');

function generateCodes() {
    const days = parseInt(document.getElementById('days').value);
    const count = parseInt(document.getElementById('count').value);

    if (days <= 0) {
        mdui.alert('天数必须大于 0');
        return;
    }

    if (count <= 0) {
        mdui.alert('生成数量必须大于 0');
        return;
    }

    fetch(`/admin/redeem/gen?count=${count}&day=${days}`, {
        method: 'POST',
        headers: {
            'X-Admin-Password': adminPassword
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            mdui.alert(text = `${data.data.map(codeInfo => codeInfo.code).join("<br>")}`, title="激活码生成成功");
            fetchCodes();
        } else {
            mdui.alert('生成失败: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mdui.alert('生成请求失败，请稍后再试');
    });
}
function fetchCodes() {
    fetch('/admin/redeem/list', {
        method: 'GET',
        headers: {
            'X-Admin-Password': adminPassword
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            const codeList = document.getElementById('code-list');
            codeList.innerHTML = '';
            data.data.forEach(code => {
                const li = document.createElement('li');
                li.className = 'mdui-list-item mdui-ripple';
                li.innerHTML = `
                    <div class="mdui-list-item-content">${code.code} (${code.date}天)</div>
                    <button class="mdui-btn mdui-btn-icon mdui-ripple" onclick="deleteCode('${code.code}')">
                        <i class="mdui-icon material-icons">delete</i>
                    </button>
                `;
                codeList.appendChild(li);
            });
        } else {
            mdui.alert('获取激活码失败: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mdui.alert('获取激活码失败，请稍后再试');
    });
}

function deleteCode(code) {
    fetch(`/admin/redeem/destroy?code=${code}`, {
        method: 'DELETE',
        headers: {
            'X-Admin-Password': adminPassword
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            mdui.alert('激活码删除成功');
            fetchCodes();
        } else {
            mdui.alert('删除失败: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mdui.alert('删除请求失败，请稍后再试');
    });
}

// 页面加载时获取激活码列表
document.addEventListener('DOMContentLoaded', fetchCodes);
fetchCodes()
</script>